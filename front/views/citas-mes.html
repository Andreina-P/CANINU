<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citas Asignadas - CANINU</title>
    
    <link rel="stylesheet" href="/assets/css/styles2.css"> 
    
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    
    <style>
        /* Estilos CSS Espec铆ficos para la p谩gina de Citas */
        .calendar-container {
            max-width: 1000px;
            margin: 40px auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #calendar {
            font-family: Arial, Helvetica, sans-serif;
        }
        .fc-event-title {
            font-weight: bold;
        }
        /* Estilo para los eventos pendientes */
        .fc-event[style*="#ff9900"] { 
            /* Se aplica a eventos de color naranja (#ff9900) */
            border-left: 5px solid #cc7a00;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <img src="/assets/images/Caninu.png" alt="logoEmpresa" width="100" height="100">
            <h1>CANINU</h1>
        </div>
        <ol>
            <li><a href="dashboard_Empleados.html">Dashboard</a></li>
            <li><a href="controles-emp.html">Controles del d铆a</a></li>
            <li><a href="#">Reportes diarios</a></li>
        </ol>
        <div class="user-profile">
            <span id="usernameField">Empleado: </span>
            <div id="CS-button"> <a href="#" id="logoutBtn">Cerrar sesi贸n</a> </div>
        </div>
    </header>

    <section style="padding: 10px;" class="dashboard-content">
        <div class="dashboard-welcome">
            <h2> Citas Asignadas para el Mes</h2>
            <div class="calendar-container">
            <div id="calendar"></div>
            </div>
        </div>  
    </section>

        <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js'></script>

<script>
    /**
     * @fileoverview Script para inicializar y configurar FullCalendar con citas del usuario.
     * * Obtiene las citas asignadas desde el endpoint /api/citas/asignadas.
         */
    let currentEmpleadoId = null;

    /**
     * @async
     * Carga la informaci贸n de la sesi贸n del usuario.
     * 1. Intenta obtener la sesi贸n del servidor (Ruta: GET /session-info).
     * 2. Si no hay sesi贸n v谩lida o el rol no es 'empleado', redirige a login.html.
     * 3. Si la sesi贸n es v谩lida, actualiza el nombre del empleado e inicializa el calendario.
     */
    async function loadSession() {
        const loggedUser = { 
            logged: true, 
            user: { username: "JuanPerez", rol: "empleado", id: 3 } 
        };
        let userData = loggedUser; 

        try {
            const res = await fetch("/session-info", { credentials: "include" });
            if (res.ok) {
                const data = await res.json();
                if (data.logged) {
                    userData = data; 
                }
            }
        } catch (e) {
            console.warn("Fallo al obtener la sesi贸n del servidor. Usando datos simulados.", e);
        }

        if (!userData.logged || userData.user.rol !== "empleado") {
            window.location.href = "login.html";
            return;
        }

        document.getElementById("usernameField").innerText = "Empleado: " + userData.user.username;
        currentEmpleadoId = userData.user.id; 

        // LLAMA A LA FUNCIN ASNCRONA
        initializeCalendar(currentEmpleadoId); 
    }

    /**
     * Listener para el bot贸n de Cerrar sesi贸n.
     * Llama al endpoint de logout en el servidor y redirige a la p谩gina de login.
     */
    document.getElementById("logoutBtn").addEventListener("click", async () => {
        await fetch("/logout", { credentials: "include" });
        window.location.href = "login.html";
    });

    document.addEventListener('DOMContentLoaded', loadSession);

    /**
     * FUNCIN CLAVE 1: OBTENER DATOS REALES DEL SERVIDOR (FETCH)
     * Obtiene la lista de citas asignadas al empleado desde el API.
     * @param {number} empleadoId - El ID del empleado logueado (actualmente no se usa en la ruta, se asume sesi贸n).
     * @returns {Promise<Array>} Un array de objetos de cita.
     */
    async function fetchCitas(empleadoId) {
        // Endpoint que llama a la ruta que acabas de crear: /api/citas/asignadas
        const API_URL = `/api/citas/asignadas`;

        try {
            const response = await fetch(API_URL, {
                method: 'GET',
                credentials: 'include', // Importante para enviar la cookie de sesi贸n
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`Error ${response.status}: El servidor no pudo obtener las citas.`);
            }

            const result = await response.json();
            
            if (result.success && result.data) {
                return result.data; // Retorna el array de citas reales
            }
            return []; 
            
        } catch (error) {
            console.error("Error al obtener las citas del servidor:", error);
            alert("No se pudieron cargar las citas asignadas. Verifique su conexi贸n y que el servidor est茅 corriendo.");
            return []; 
        }
    }

    /**
     * FUNCIN CLAVE 2: INICIALIZAR Y RENDERIZAR CALENDARIO
     * Inicializa y renderiza el componente FullCalendar.
     * 1. Llama a fetchCitas() para obtener los datos del servidor.
     * 2. Mapea los datos de las citas al formato de eventos de FullCalendar.
     * 3. Configura y renderiza el calendario en la interfaz.
     * @param {number} empleadoId - El ID del empleado logueado.
     */
    async function initializeCalendar(empleadoId) {
        // 1. OBTENER DATOS: Llama al servidor y espera la respuesta
        const citasEmpleado = await fetchCitas(empleadoId);

        const calendarEl = document.getElementById('calendar');

        // 2. Mapear los datos al formato FullCalendar
        const eventos = citasEmpleado.map(cita => {
            // Usa las columnas reales de la base de datos (fecha, hora)
            const fechaBase = cita.fecha.substring(0, 10);
            const startDateTime = `${fechaBase}T${cita.hora}`;

            
            let bgColor = '#ff9900'; 
            if (cita.estado === 'Completada') {
                bgColor = '#4CAF50';
            }

            return {
                id: cita.id,
                title: `${cita.detalle} (${cita.tipo_cita})`, 
                start: startDateTime, 
                allDay: false,
                backgroundColor: bgColor,
                borderColor: bgColor,
                extendedProps: {
                    estado: cita.estado,
                    id_mascota: cita.id_mascota
                }
            };
        });

        // 3. Configuraci贸n y Renderizado del calendario
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth', 
            locale: 'es', 
            height: 'auto', 
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth'
            },

            eventTimeFormat: {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true,
                meridiem: 'short' 
            },

            events: eventos, // Carga de citas obtenidas

            eventClick: function(info) {
                const cita = info.event;
                alert(`
                    Detalle de la Cita:
                    Tipo: ${cita.title}
                    Fecha: ${cita.start.toLocaleDateString()}
                    Hora: ${cita.start.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: true })}
                    Estado: ${cita.extendedProps.estado}
                `);
            }
        });

        calendar.render();
    }
</script>
</body>
</html>